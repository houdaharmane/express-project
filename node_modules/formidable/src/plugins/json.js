/* eslint-disable no-underscore-dangle */

<<<<<<< HEAD
import JSONParser from '../parsers/JSON.js';

export const jsonType = 'json';
// the `options` is also available through the `this.options` / `formidable.options`
export default function plugin(formidable, options) {
=======
'use strict';

const JSONParser = require('../parsers/JSON');

// the `options` is also available through the `this.options` / `formidable.options`
module.exports = function plugin(formidable, options) {
>>>>>>> 5feea03a860e1851f4a7432dfd45499e26af9716
  // the `this` context is always formidable, as the first argument of a plugin
  // but this allows us to customize/test each plugin

  /* istanbul ignore next */
  const self = this || formidable;

  if (/json/i.test(self.headers['content-type'])) {
    init.call(self, self, options);
  }
<<<<<<< HEAD

  return self;
=======
>>>>>>> 5feea03a860e1851f4a7432dfd45499e26af9716
};

// Note that it's a good practice (but it's up to you) to use the `this.options` instead
// of the passed `options` (second) param, because when you decide
// to test the plugin you can pass custom `this` context to it (and so `this.options`)
function init(_self, _opts) {
<<<<<<< HEAD
  this.type = jsonType;

  const parser = new JSONParser(this.options);

  parser.on('data', (fields) => {
    this.fields = fields;
=======
  this.type = 'json';

  const parser = new JSONParser(this.options);

  parser.on('data', ({ key, value }) => {
    this.emit('field', key, value);
>>>>>>> 5feea03a860e1851f4a7432dfd45499e26af9716
  });

  parser.once('end', () => {
    this.ended = true;
    this._maybeEnd();
  });

  this._parser = parser;
}
